# SPDX-FileCopyrightText: Copyright (C) 2025 FabrÃ­cio Barros Cabral
# SPDX-License-Identifier: MIT
---
name: c-cpp-release
'on':
  push:
    tags:
      - '*'
jobs:
  c-cpp-build-linux:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool \
            pkg-config libpcap-dev tcl-dev
      - name: Configure and build
        run: |
          ./autogen.sh
          ./configure
          make
      - name: Get properties from configure.ac
        id: props
        shell: bash
        run: |
          name=$(grep AC_INIT configure.ac | sed -n 's/AC_INIT(\[\([^]]*\)\],.*/\1/p')
          echo "name=$name" >> $GITHUB_OUTPUT
          version=$(grep AC_INIT configure.ac | sed -n 's/AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])/\1/p')
          echo "version=$version" >> $GITHUB_OUTPUT
      - name: Create source package
        run: |
          make dist
      - name: Create Linux binary package
        run: |
          make binary-dist
      - name: Prepare packages to distribution
        run: |
          mkdir -p dist
          mv "${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}.tar.gz" \
            "dist/${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}.tar.gz"
          mv "${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}-bin.tar.gz" \
            "dist/${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}-linux.tar.gz"
  c-cpp-build-macos:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          brew update
          brew upgrade
          brew install autoconf automake libtool tcl-tk libpcap
      - name: Configure and build
        run: |
          ./autogen.sh
          ./configure
          make
      - name: Get properties from configure.ac
        id: props
        shell: bash
        run: |
          name=$(grep AC_INIT configure.ac | sed -n 's/AC_INIT(\[\([^]]*\)\],.*/\1/p')
          echo "name=$name" >> $GITHUB_OUTPUT
          version=$(grep AC_INIT configure.ac | sed -n 's/AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])/\1/p')
          echo "version=$version" >> $GITHUB_OUTPUT
      - name: Create macOS binary package
        run: |
          make binary-dist
      - name: Prepare package to distribution
        run: |
          mkdir -p dist
          mv "${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}-bin.tar.gz" \
            "dist/${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}-macos.tar.gz"
  c-cpp-release:
    runs-on: ubuntu-24.04
    needs: [c-cpp-build-linux, c-cpp-build-macos]
    steps:
      - name: Set release tag
        id: tag
        run: |
          # Detects which tag triggered the build
          echo "tag=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
      - name: Release artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: dist/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# $smu-mark$
# $name: Makefile.in$
# $author: Salvatore Sanfilippo 'antirez'$
# $copyright: Copyright (C) 1999 by Salvatore Sanfilippo$
# $license: This software is under GPL version 2 of license$
# $date: Sun Jul 25 17:56:15 MET DST 1999$
# $rev: 3$

CC= gcc
AR=/usr/bin/ar
RANLIB=/usr/bin/ranlib
CCOPT= -O2 -Wall @PCAP_INCLUDE@ @TCL_INC@ @USE_TCL@
DEBUG= -g
#uncomment the following if you need libpcap based build under linux
#(not raccomanded)
COMPILE_TIME=
INSTALL_MANPATH=@MANPATH@
@PCAP@

# Source directory
SRC_DIR = src

ARSOBJ = $(SRC_DIR)/ars.o $(SRC_DIR)/apd.o $(SRC_DIR)/split.o $(SRC_DIR)/rapd.o

OBJ= $(SRC_DIR)/main.o $(SRC_DIR)/getifname.o $(SRC_DIR)/getlhs.o \
	$(SRC_DIR)/parseoptions.o $(SRC_DIR)/datafiller.o \
	$(SRC_DIR)/datahandler.o $(SRC_DIR)/gethostname.o \
	$(SRC_DIR)/binding.o $(SRC_DIR)/getusec.o $(SRC_DIR)/opensockraw.o \
	$(SRC_DIR)/logicmp.o $(SRC_DIR)/waitpacket.o $(SRC_DIR)/resolve.o \
	$(SRC_DIR)/sendip.o $(SRC_DIR)/sendicmp.o $(SRC_DIR)/sendudp.o \
	$(SRC_DIR)/sendtcp.o $(SRC_DIR)/cksum.o $(SRC_DIR)/statistics.o \
	$(SRC_DIR)/usage.o $(SRC_DIR)/version.o $(SRC_DIR)/antigetopt.o \
	$(SRC_DIR)/sockopt.o $(SRC_DIR)/listen.o \
	$(SRC_DIR)/sendhcmp.o $(SRC_DIR)/memstr.o $(SRC_DIR)/rtt.o \
	$(SRC_DIR)/relid.o $(SRC_DIR)/sendip_handler.o \
	$(SRC_DIR)/libpcap_stuff.o $(SRC_DIR)/memlockall.o $(SRC_DIR)/memunlockall.o \
	$(SRC_DIR)/memlock.o $(SRC_DIR)/memunlock.o $(SRC_DIR)/ip_opt_build.o \
	$(SRC_DIR)/display_ipopt.o $(SRC_DIR)/sendrawip.o $(SRC_DIR)/signal.o $(SRC_DIR)/send.o \
	$(SRC_DIR)/strlcpy.o $(SRC_DIR)/arsglue.o $(SRC_DIR)/random.o $(SRC_DIR)/scan.o \
	$(SRC_DIR)/hstring.o $(SRC_DIR)/script.o $(SRC_DIR)/interface.o \
	$(SRC_DIR)/adbuf.o $(SRC_DIR)/hex.o $(SRC_DIR)/apdutils.o $(SRC_DIR)/sbignum.o \
	$(SRC_DIR)/sbignum-tables.o $(ARSOBJ)

all: .depend hping3

dep: .depend
.depend:
	@echo "Making dependences... "
	@$(CC) -MM $(SRC_DIR)/*.c | sed 's@^\(.*\)\.o:@$(SRC_DIR)/\1.o:@' > .depend

libars.a: $(ARSOBJ)
	$(AR) rc $@ $^
	$(RANLIB) $@

hping3: byteorder.h $(OBJ)
	$(CC) -o hping3 $(CCOPT) $(DEBUG) $(OBJ) -L/usr/local/lib $(PCAP) @SOLARISLIB@ @TCL_LIB@
	@echo
	./hping3 -v
	@echo "use \`make strip' to strip hping3 binary"
	@echo "use \`make install' to install hping3"

hping3-static: byteorder.h $(OBJ)
	$(CC) -static -o hping3-static $(CCOPT) $(DEBUG) $(OBJ) -L/usr/local/lib $(PCAP) @SOLARISLIB@ @TCL_LIB@ -ldl

byteorder.h:
	./configure

$(SRC_DIR)/%.o: $(SRC_DIR)/%.c
	$(CC) -c $(CCOPT) $(DEBUG) $(COMPILE_TIME) $< -o $@

clean:
	rm -rf hping3 $(SRC_DIR)/*.o libars.a

distclean:
	rm -rf hping3 $(SRC_DIR)/*.o $(SRC_DIR)/byteorder $(SRC_DIR)/byteorder.h $(SRC_DIR)/systype.h Makefile libars.a .depend

install: hping3
	cp -f hping3 /usr/sbin/
	chmod 755 /usr/sbin/hping3
	ln -s /usr/sbin/hping3 /usr/sbin/hping
	ln -s /usr/sbin/hping3 /usr/sbin/hping2
	@if [ -d ${INSTALL_MANPATH}/man8 ]; then \
		cp ./docs/hping3.8 ${INSTALL_MANPATH}/man8; \
		chmod 644 ${INSTALL_MANPATH}/man8/hping3.8; \
	else \
		echo "@@@@@@ WARNING @@@@@@"; \
		echo "Can't install the man page: ${INSTALL_MANPATH}/man8 does not exist"; \
	fi

strip: hping3
	@ls -l ./hping3
	strip hping3
	@ls -l ./hping3

-include .depend
